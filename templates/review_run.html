{% extends "base.html" %}
{% block title %}Run checklist – {{ review.app_name }}{% endblock %}
{% block content %}
  <h1>Run checklist: {{ review.app_name }}</h1>
  <p class="muted">App ID: {{ review.app_id }} · Date: {{ review.date }}</p>

  {% if not sections_criteria %}
    <p class="muted">No checklist items. <a href="{{ url_for('checklist_edit') }}">Add criteria</a> first.</p>
  {% else %}
  <section class="card">
    <form method="post" action="{{ url_for('review_run', review_id=review.id) }}">
      {% for sec in sections_criteria %}
        <div class="criteria-section">
          <h3 class="section-title">{{ sec.name }}</h3>
          <table class="run-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Criterion</th>
                <th>Result</th>
              </tr>
            </thead>
            <tbody>
              {% for c in sec['items'] %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>{{ c.text }}</td>
                  <td class="result-buttons">
                    {% for opt in results_options %}
                      <label class="result-label">
                        <input type="radio" name="result_{{ c.id }}" value="{{ opt }}" {% if c.result == opt %}checked{% endif %}>
                        <span class="result-{{ opt|lower }}">{{ opt }}</span>
                      </label>
                    {% endfor %}
                    <span class="attach-wrap">
                      <a href="#" class="attach-link" data-for="attach-field-{{ c.id }}" aria-expanded="{{ 'true' if c.attachment else 'false' }}">Attach</a>
                      <span id="attach-field-{{ c.id }}" class="attach-field {% if not c.attachment %}attach-field-hidden{% endif %}">
                        <input type="text" name="attachment_{{ c.id }}" value="{{ c.attachment }}" placeholder="URL or ticket #" class="attach-input" title="Screenshot URL or ticket reference">
                      </span>
                    </span>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endfor %}
      <p class="actions">
        <button type="submit" name="action" value="save" class="btn">Save and continue later</button>
        <button type="submit" name="action" value="finish" class="btn btn-primary">Finish review</button>
      </p>
    </form>
  </section>
  {% endif %}
  <p><a href="{{ url_for('review_detail', review_id=review.id) }}">Back to review</a></p>

  <script>
    document.querySelectorAll('.attach-link').forEach(function(a) {
      a.addEventListener('click', function(e) {
        e.preventDefault();
        var el = document.getElementById(a.getAttribute('data-for'));
        if (!el) return;
        el.classList.toggle('attach-field-hidden');
        a.setAttribute('aria-expanded', el.classList.contains('attach-field-hidden') ? 'false' : 'true');
      });
    });
  </script>
{% endblock %}
