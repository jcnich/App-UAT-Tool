{% extends "base.html" %}
{% block title %}Run checklist – {{ review.app_name }}{% endblock %}
{% block content %}
  <h1>Run checklist: {{ review.app_name }}</h1>
  <p class="muted">App ID: {{ review.app_id }} · Date: {{ review.date }}</p>

  {% if not sections_criteria %}
    <p class="muted">No checklist items. <a href="{{ url_for('checklist_edit') }}">Add criteria</a> first.</p>
  {% else %}
  <section class="card">
    <form method="post" action="{{ url_for('review_run', review_id=review.id) }}" id="review-run-form">
      <div class="review-run-meta form-card" style="margin-bottom: 1.5rem;">
        <p class="muted" style="margin-top: 0; margin-bottom: 0.5rem;">You can edit these during the review.</p>
        <label for="store_url">Store URL</label>
        <input type="url" id="store_url" name="store_url" value="{{ review.store_url or '' }}" placeholder="https://…">
        <label for="app_owner_email">App owner email</label>
        <input type="email" id="app_owner_email" name="app_owner_email" value="{{ review.app_owner_email or '' }}">
        <label for="overall_notes">Overall notes</label>
        <textarea id="overall_notes" name="overall_notes" rows="3">{{ review.overall_notes or '' }}</textarea>
      </div>
      <p class="keyboard-hint muted" id="checklist-keyboard-hint">Tab into the checklist, then use arrow keys to move between rows; 1–4 for Pass / Fail / Partial / NA; Enter to attach.</p>
      <div id="checklist-keyboard-grid" class="checklist-keyboard-grid" role="grid" aria-label="Checklist results" aria-describedby="checklist-keyboard-hint" tabindex="0">
      {% for sec in sections_criteria %}
        <div class="criteria-section">
          <h3 class="section-title">{{ sec.name }}</h3>
          <table class="run-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Criterion</th>
                <th>Result</th>
              </tr>
            </thead>
            <tbody>
              {% for c in sec['items'] %}
                <tr class="result-row" data-criterion-id="{{ c.id }}">
                  <td>{{ loop.index }}</td>
                  <td>{{ c.text }}</td>
                  <td class="result-buttons result-cell">
                    <div class="result-radiogroup" role="radiogroup" aria-label="Result">
                      {% for opt in results_options %}
                        <label class="result-label">
                          <input type="radio" name="result_{{ c.id }}" value="{{ opt }}" {% if c.result == opt %}checked{% endif %} class="result-radio">
                          <span class="result-{{ opt|lower }}">{{ opt }}</span>
                        </label>
                      {% endfor %}
                    </div>
                    <span class="attach-wrap">
                      <a href="#" class="attach-link" data-for="attach-field-{{ c.id }}" aria-expanded="{{ 'true' if c.attachment else 'false' }}" tabindex="-1">Attach</a>
                      <span id="attach-field-{{ c.id }}" class="attach-field {% if not c.attachment %}attach-field-hidden{% endif %}">
                        <input type="text" name="attachment_{{ c.id }}" value="{{ c.attachment }}" placeholder="URL or ticket #" class="attach-input" title="Screenshot URL or ticket reference" tabindex="-1">
                      </span>
                    </span>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endfor %}
      </div>
      <p class="actions">
        <button type="submit" name="action" value="save" class="btn">Save and continue later</button>
        <button type="submit" name="action" value="finish" class="btn btn-primary">Finish review</button>
      </p>
    </form>
  </section>
  {% endif %}
  <p><a href="{{ url_for('review_detail', review_id=review.id) }}">Back to review</a></p>

  <script>
    document.querySelectorAll('.attach-link').forEach(function(a) {
      a.addEventListener('click', function(e) {
        e.preventDefault();
        var el = document.getElementById(a.getAttribute('data-for'));
        if (!el) return;
        el.classList.toggle('attach-field-hidden');
        a.setAttribute('aria-expanded', el.classList.contains('attach-field-hidden') ? 'false' : 'true');
      });
    });
  </script>
  <script src="{{ url_for('static', filename='checklist-keyboard.js') }}"></script>
{% endblock %}
