{% extends "base.html" %}
{% block title %}New review – App UAT Reviews{% endblock %}
{% block content %}
  <h1>New review</h1>
  {% if step == 2 %}
    <p>Select which sections to include in this review. You can change defaults on the <a href="{{ url_for('checklist_edit') }}">Checklist</a> page.</p>
  {% else %}
    <p>Enter app metadata. When started from Re-review, fields are pre-filled.</p>
  {% endif %}

  {% if step == 2 %}
  <section class="card">
    <form method="post" action="{{ url_for('review_new', from_id=from_id) if from_id else url_for('review_new') }}" class="form-card" id="review-new-step2-form">
      <input type="hidden" name="action" value="create">
      <input type="hidden" name="app_name" value="{{ (prefill or {}).get('app_name', '') }}">
      <input type="hidden" name="app_id" value="{{ (prefill or {}).get('app_id', '') }}">
      <input type="hidden" name="date" value="{{ (prefill or {}).get('date', '') }}">
      <input type="hidden" name="app_owner_email" value="{{ (prefill or {}).get('app_owner_email', '') }}">
      <input type="hidden" name="overall_notes" value="{{ (prefill or {}).get('overall_notes', '') }}">
      <p><strong>App:</strong> {{ (prefill or {}).get('app_name', '') }} · {{ (prefill or {}).get('app_id', '') }}</p>
      <label>Sections to include</label>
      <p class="section-select-actions">
        <button type="button" class="btn btn-sm" id="select-all-sections">Select all</button>
        <button type="button" class="btn btn-sm" id="deselect-all-sections">Deselect all</button>
      </p>
      <ul class="section-checkbox-list">
        {% for sec in sections %}
          <li>
            <label class="checklist-checkbox-wrap">
              <input type="checkbox" name="section_ids" value="{{ sec.id }}" class="section-cb" {% if sec.selected %}checked{% endif %}>
              <span class="checklist-checkbox-label">{{ sec.name }}</span>
            </label>
          </li>
        {% endfor %}
      </ul>
      <p><button type="submit" class="btn btn-primary">Start review</button></p>
    </form>
  </section>
  <script>
    (function() {
      var selectAll = document.getElementById('select-all-sections');
      var deselectAll = document.getElementById('deselect-all-sections');
      var checkboxes = document.querySelectorAll('.section-cb');
      if (selectAll) selectAll.addEventListener('click', function() { checkboxes.forEach(function(cb) { cb.checked = true; }); });
      if (deselectAll) deselectAll.addEventListener('click', function() { checkboxes.forEach(function(cb) { cb.checked = false; }); });
    })();
  </script>
  {% else %}
  <section class="card">
    <form method="post" action="{{ url_for('review_new', from_id=from_id) if from_id else url_for('review_new') }}" class="form-card">
      <input type="hidden" name="action" value="next">
      <label>App name <span class="required">*</span></label>
      <input type="text" name="app_name" value="{{ (prefill or {}).get('app_name', '') }}" required>
      <label>App ID <span class="required">*</span></label>
      <input type="text" name="app_id" value="{{ (prefill or {}).get('app_id', '') }}" required>
      <label>Date <span class="required">*</span></label>
      <input type="date" name="date" value="{{ (prefill or {}).get('date', '') }}" required>
      <label>App owner email</label>
      <input type="email" name="app_owner_email" value="{{ (prefill or {}).get('app_owner_email', '') }}">
      <label>Overall notes</label>
      <textarea name="overall_notes" rows="3">{{ (prefill or {}).get('overall_notes', '') }}</textarea>
      <p><button type="submit" class="btn btn-primary">Next: Select sections</button></p>
    </form>
  </section>
  {% endif %}
{% endblock %}
